# 架构设计：成渝地区铁路客运智能分析与可视化系统

## 架构概览
系统采用分层架构，将数据采集、处理、分析与展示解耦，并依托云原生服务保障可扩展性、韧性与快速迭代能力。

## 逻辑架构
```
+------------------+        +----------------------+        +---------------------+
| 外部数据源       | -----> | 采集与流处理          | -----> | 数据湖仓             |
| (运营方、物联网) |        | (ETL、CDC、校验)      |        | (原始区、汇总区)     |
+------------------+        +----------------------+        +----------+----------+
                                                             |          |
                                                             v          v
                                                     +--------------+  +----------------+
                                                     | 分析服务      |  | 数据服务        |
                                                     | (机器学习、KPI)|  | (API、报表)     |
                                                     +------+-------+  +----------------+
                                                            |
                                                            v
                                                   +-------------------+
                                                   | 可视化/用户界面    |
                                                   | (仪表板、地图)     |
                                                   +-------------------+
```
关键组件包括：
- **外部数据源**：售票、时刻表、SCADA 传感器、客流计数设备等。
- **采集与流处理**：适配器、消息队列与数据校验服务。
- **数据湖仓**：用于存放原始数据与治理后的汇总数据。
- **分析服务**：批处理与流式分析引擎，产出 KPI 与预测结果。
- **数据服务**：REST/GraphQL API、报表生成以及对外集成接口。
- **可视化/用户界面**：网页仪表板、地理可视化与告警工作流。

## 物理架构
- **云基础设施**：Kubernetes 集群承载微服务；托管对象存储支撑湖仓；关系型分析型数据仓库存放治理数据。
- **网络**：构建虚拟专用云（VPC），在采集、分析、展示层设置独立子网；通过 VPN/专线与市级数据中心互联。
- **计算**：采集与 API 服务采用自动扩缩容容器；定时 ETL 使用无服务器函数；需要时提供 GPU 节点进行模型训练。
- **存储**：
  - 对象存储桶按日期/来源分区保存原始数据。
  - 列式数据仓库存放汇总数据集与聚合指标。
  - NoSQL 缓存（如 Redis）提供高频仪表板指标的快速访问。
- **安全控制**：身份与访问管理（IAM）、密钥管理、Web 应用防火墙（WAF）及集中式日志平台（如 ELK 或云服务原生方案）。

## 功能架构
| 分层 | 职责 | 核心组件 |
| --- | --- | --- |
| 展示层 | 提供用户界面、可视化与告警 | Web 仪表板、地图渲染、通知服务 |
| 应用服务层 | 编排业务逻辑、执行权限控制与工作流管理 | API 网关、认证服务、告警服务、报表引擎 |
| 分析层 | 提供预测、指标计算与情景模拟 | 机器学习服务、分析管道、批处理调度器 |
| 数据管理层 | 负责采集、校验、存储与数据开放 | ETL 适配器、流式作业、元数据目录、湖仓存储 |
| 基础设施层 | 提供计算、网络与可观测性 | Kubernetes、CI/CD 流水线、监控、日志 |

## 数据架构
### 数据流
1. 数据适配器从运营系统采集时刻表、票务和运营指标。
2. 流式处理管道校验并将数据写入原始存储，同时输出质量指标。
3. 批处理作业将数据标准化，生成汇总表（车站、线路、票务事实等）。
4. 分析任务生成 KPI、预测与模拟结果，并存储于专用数据集市。
5. API 与仪表板查询治理数据和分析成果，为终端用户提供服务。

### 核心数据实体及 ER 图
```
+-----------+        +----------------+        +-------------+
| Stations  |        | Line_Stations  |        |   Lines     |
|-----------|        |----------------|        |-------------|
| station_id PK <----| station_id  FK |----->  | line_id  PK |
| name              | line_id     FK |<-----+ | name        |
| city              | sequence_num  |      | | type        |
| longitude         +----------------+      | | operator    |
| latitude                                  | +-------------+
+-----------+                               |
                                             |
                                             v
                                      +--------------+
                                      |   Tickets    |
                                      |--------------|
                                      | ticket_id PK |
                                      | line_id   FK |
                                      | origin_id FK |
                                      | dest_id   FK |
                                      | travel_date  |
                                      | fare         |
                                      | passenger_id |
                                      +--------------+
```
- **Stations**：记录每个客运站及其地理属性。
- **Lines**：记录连接多站的铁路线路或服务。
- **Line_Stations**：关联表，用于描述各线路的站点顺序。
- **Tickets**：票务事实表，存储与线路及站点关联的交易记录。

其他支持实体（未在图中展示）包括客流统计、服务中断和预测结果等。

## 集成模式
- **ETL/ELT 作业**：用于导入历史批量数据。
- **事件流处理**（如 Kafka）：支撑近实时客流与运营事件更新。
- **API 网关**：统一对外暴露分析接口并管理外部集成。
- **Webhook/通知服务**：向利益相关方推送实时告警。

## 技术栈建议
- **数据采集**：Apache NiFi 或基于 Spring Boot/FastAPI 的自研微服务。
- **流处理**：Apache Kafka 配合 Schema Registry。
- **存储**：构建于对象存储之上的 Delta Lake 或 Apache Iceberg；治理层采用 PostgreSQL 或 ClickHouse。
- **分析**：Spark、Flink 或云原生等价服务；模型生命周期管理建议使用 MLflow。
- **可视化**：基于 React 的定制仪表板或 Superset 等开源 BI 工具，配合定制地图组件。
- **DevOps**：基于 Git 的 CI/CD、基础设施即代码（Terraform）、Prometheus/Grafana 监控体系。

## 安全与合规
- 实施最小权限的 IAM 策略、多因素认证及网络分段。
- 在向分析团队共享数据前进行脱敏或匿名化处理。
- 保留审计日志，并遵循相关交通数据法规及网络安全要求。

## 可扩展性与可靠性
- 根据队列长度与 CPU 利用率设置自动扩缩策略，保障采集与分析任务能力。
- 采用蓝绿部署策略，降低发布过程中的停机风险。
- 建立跨地域容灾与恢复演练流程，确保灾难恢复能力。
